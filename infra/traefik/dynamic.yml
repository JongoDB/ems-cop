# Traefik Dynamic Configuration — EMS-COP Routes
# Maps API prefixes to backend services via Docker internal DNS
# Public routes (no auth) use higher priority to match before protected catch-all

http:
  # ════════════════════════════════════════════
  #  MIDDLEWARES
  # ════════════════════════════════════════════
  middlewares:
    auth-verify:
      forwardAuth:
        address: "http://auth-service:3001/api/v1/auth/verify"
        authResponseHeaders:
          - "X-User-ID"
          - "X-User-Roles"
          - "X-Session-ID"

    cors-headers:
      headers:
        accessControlAllowOriginList:
          - "*"
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "PATCH"
          - "DELETE"
          - "OPTIONS"
        accessControlAllowHeaders:
          - "Authorization"
          - "Content-Type"
        accessControlMaxAge: 86400

  # ════════════════════════════════════════════
  #  ROUTERS — PUBLIC (no auth required)
  # ════════════════════════════════════════════
  routers:
    # Auth endpoints (login, refresh) — must be public
    auth-public:
      rule: "PathPrefix(`/api/v1/auth/login`) || PathPrefix(`/api/v1/auth/refresh`)"
      entryPoints: [web]
      service: auth
      middlewares: [cors-headers]
      priority: 100

    # C2 shell WebSocket — auth handled by c2-gateway via query param token
    c2-shell:
      rule: "PathRegexp(`/api/v1/c2/sessions/.+/shell`)"
      entryPoints: [web]
      service: c2
      middlewares: [cors-headers]
      priority: 90

    # Frontend SPA — public
    frontend:
      rule: "PathPrefix(`/`)"
      entryPoints: [web]
      service: frontend
      priority: 1

  # ════════════════════════════════════════════
  #  ROUTERS — PROTECTED (auth-verify middleware)
  # ════════════════════════════════════════════
    auth:
      rule: "PathPrefix(`/api/v1/auth`)"
      entryPoints: [web]
      service: auth
      middlewares: [auth-verify, cors-headers]
      priority: 50

    workflow:
      rule: "PathPrefix(`/api/v1/workflows`)"
      entryPoints: [web]
      service: workflow
      middlewares: [auth-verify, cors-headers]
      priority: 50

    ticket:
      rule: "PathPrefix(`/api/v1/tickets`)"
      entryPoints: [web]
      service: ticket
      middlewares: [auth-verify, cors-headers]
      priority: 50

    commands:
      rule: "PathPrefix(`/api/v1/commands`)"
      entryPoints: [web]
      service: ticket
      middlewares: [auth-verify, cors-headers]
      priority: 50

    dashboard-api:
      rule: "PathPrefix(`/api/v1/dashboards`)"
      entryPoints: [web]
      service: dashboard-api
      middlewares: [auth-verify, cors-headers]
      priority: 50

    c2:
      rule: "PathPrefix(`/api/v1/c2`)"
      entryPoints: [web]
      service: c2
      middlewares: [auth-verify, cors-headers]
      priority: 50

    audit:
      rule: "PathPrefix(`/api/v1/audit`)"
      entryPoints: [web]
      service: audit
      middlewares: [auth-verify, cors-headers]
      priority: 50

    notification:
      rule: "PathPrefix(`/api/v1/notifications`)"
      entryPoints: [web]
      service: notification
      middlewares: [auth-verify, cors-headers]
      priority: 50

    operations:
      rule: "PathPrefix(`/api/v1/operations`)"
      entryPoints: [web]
      service: workflow
      middlewares: [auth-verify, cors-headers]
      priority: 50

    networks:
      rule: "PathPrefix(`/api/v1/networks`)"
      entryPoints: [web]
      service: endpoint
      middlewares: [auth-verify, cors-headers]
      priority: 50

    nodes:
      rule: "PathPrefix(`/api/v1/nodes`)"
      entryPoints: [web]
      service: endpoint
      middlewares: [auth-verify, cors-headers]
      priority: 50

    edges:
      rule: "PathPrefix(`/api/v1/edges`)"
      entryPoints: [web]
      service: endpoint
      middlewares: [auth-verify, cors-headers]
      priority: 50

    display-schemas:
      rule: "PathPrefix(`/api/v1/display-schemas`)"
      entryPoints: [web]
      service: endpoint
      middlewares: [auth-verify, cors-headers]
      priority: 50

    import-parsers:
      rule: "PathPrefix(`/api/v1/import-parsers`)"
      entryPoints: [web]
      service: endpoint
      middlewares: [auth-verify, cors-headers]
      priority: 50

    findings:
      rule: "PathPrefix(`/api/v1/findings`)"
      entryPoints: [web]
      service: ticket
      middlewares: [auth-verify, cors-headers]
      priority: 50

    endpoint:
      rule: "PathPrefix(`/api/v1/endpoints`)"
      entryPoints: [web]
      service: endpoint
      middlewares: [auth-verify, cors-headers]
      priority: 50

    ws:
      rule: "PathPrefix(`/ws`)"
      entryPoints: [web]
      service: ws
      middlewares: [auth-verify, cors-headers]
      priority: 50

  # ════════════════════════════════════════════
  #  SERVICES (backend targets)
  # ════════════════════════════════════════════
  services:
    auth:
      loadBalancer:
        servers:
          - url: "http://auth-service:3001"
    workflow:
      loadBalancer:
        servers:
          - url: "http://workflow-engine:3002"
    ticket:
      loadBalancer:
        servers:
          - url: "http://ticket-service:3003"
    dashboard-api:
      loadBalancer:
        servers:
          - url: "http://dashboard-service:3004"
    c2:
      loadBalancer:
        servers:
          - url: "http://c2-gateway:3005"
    audit:
      loadBalancer:
        servers:
          - url: "http://audit-service:3006"
    notification:
      loadBalancer:
        servers:
          - url: "http://notification-service:3007"
    endpoint:
      loadBalancer:
        servers:
          - url: "http://endpoint-service:3008"
    ws:
      loadBalancer:
        servers:
          - url: "http://ws-relay:3009"
    frontend:
      loadBalancer:
        servers:
          - url: "http://frontend:80"
